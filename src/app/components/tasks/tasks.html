<div *ngIf="!(showAddTask$ | async); else formView">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Lista de Tarefas</h2>
  </div>

  <div class="d-flex justify-content-end align-items-center small mb-3">
    <span class="me-2">Legenda:</span>
    <span class="badge rounded-pill text-bg-warning me-2">Pendente</span>
    <span class="badge rounded-pill text-bg-info me-2">Em andamento</span>
    <span class="badge rounded-pill text-bg-success">Concluído</span>
  </div>

  <div class="accordion" id="tasksAccordion">
    <div
      *ngFor="let task of tasks$ | async; let i = index"
      class="accordion-item"
      [ngClass]="getTaskClass(task.status)"
    >
      <h2 class="accordion-header">
        <button
          class="accordion-button collapsed"
          type="button"
          data-bs-toggle="collapse"
          [attr.data-bs-target]="'#collapse' + i"
        >
          {{ task.nome }}
        </button>
      </h2>
      <div
        [id]="'collapse' + i"
        class="accordion-collapse collapse"
        data-bs-parent="#tasksAccordion"
      >
        <div class="accordion-body">
          <strong>Início:</strong> {{ task.inicio | date : 'dd/MM/yyyy' }} <br />
          <strong>Conclusão:</strong> {{ task.conclusao | date : 'dd/MM/yyyy' }} <br />
          <strong>Custo Estimado:</strong> {{ task.custo_estimado | currency : 'BRL' }} <br />
          <strong>Status:</strong>
          <span class="badge rounded-pill text-bg-primary">{{ task.status }}</span>
          <hr />
          <div class="d-flex justify-content-end">
            <button class="btn btn-warning btn-sm me-2" (click)="onEdit(task)">
              <i class="fas fa-pencil-alt"></i> Editar
            </button>
            <button class="btn btn-danger btn-sm" (click)="deleteTask(task)">
              <i class="fas fa-trash-alt"></i> Excluir
            </button>
          </div>

          <hr />
          <h5>Comentários</h5>
          <div *ngIf="!task.comments || task.comments.length === 0" class="text-muted small mb-3">
            Nenhum comentário ainda.
          </div>
          <div
            *ngFor="let comment of task.comments"
            class="mb-2 d-flex justify-content-between align-items-start"
          >
            <div>
              <strong>{{ comment.author }}:</strong>
              <p class="mb-0 ms-2" style="white-space: pre-wrap">{{ comment.content }}</p>
            </div>
            <button
              class="btn btn-outline-danger btn-sm"
              (click)="onDeleteComment(task.id, comment.id)"
            >
              &times;
            </button>
          </div>

          <form #commentForm="ngForm" (ngSubmit)="onAddComment(commentForm, task.id)" class="mt-3">
            <div class="mb-2">
              <input
                type="text"
                name="author"
                placeholder="Seu nome"
                class="form-control form-control-sm"
                ngModel
                #author="ngModel"
                value="Anônimo"
              />
            </div>
            <div class="mb-2">
              <textarea
                name="content"
                placeholder="Escreva um comentário..."
                class="form-control form-control-sm"
                required
                ngModel
                #content="ngModel"
              ></textarea>
            </div>
            <button type="submit" class="btn btn-secondary btn-sm" [disabled]="commentForm.invalid">
              Comentar
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #formView>
  <app-task-form
    [taskToEdit]="taskToEdit"
    (taskSubmit)="handleTaskSubmit($event)"
    (cancel)="handleCancel()"
  >
  </app-task-form>
</ng-template>
